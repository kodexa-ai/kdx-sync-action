name: 'Kodexa Sync'
description: 'GitOps deployment for Kodexa metadata - branch mappings drive everything'
author: 'Kodexa, Inc.'

branding:
  icon: 'refresh-cw'
  color: 'blue'

inputs:
  sync-config:
    description: 'Path to sync-config.yaml (auto-discovered if not specified)'
    required: false
    default: ''

  metadata-dir:
    description: 'Metadata directory override (auto-discovered if not specified)'
    required: false
    default: ''

  dry-run:
    description: 'Preview deployment without making changes (true/false)'
    required: false
    default: 'false'

  kdx-version:
    description: 'kdx-cli version to use (default: latest)'
    required: false
    default: 'latest'

outputs:
  targets-deployed:
    description: 'Number of targets deployed'
    value: ${{ steps.sync.outputs.targets }}

  resources-created:
    description: 'Number of resources created'
    value: ${{ steps.sync.outputs.resources_created }}

  resources-updated:
    description: 'Number of resources updated'
    value: ${{ steps.sync.outputs.resources_updated }}

  resources-skipped:
    description: 'Number of resources skipped (unchanged)'
    value: ${{ steps.sync.outputs.resources_skipped }}

runs:
  using: 'composite'
  steps:
    - name: Detect OS and Architecture
      id: detect
      shell: bash
      run: |
        OS=$(uname -s | tr '[:upper:]' '[:lower:]')
        ARCH=$(uname -m)

        # Normalize OS name
        case "$OS" in
          linux*)   OS="linux" ;;
          darwin*)  OS="darwin" ;;
          mingw*)   OS="windows" ;;
          msys*)    OS="windows" ;;
          cygwin*)  OS="windows" ;;
          *)        echo "âŒ Unsupported OS: $OS"; exit 1 ;;
        esac

        # Normalize architecture
        case "$ARCH" in
          x86_64|amd64)   ARCH="x86_64" ;;
          aarch64|arm64)  ARCH="arm64" ;;
          *)              echo "âŒ Unsupported architecture: $ARCH"; exit 1 ;;
        esac

        echo "os=$OS" >> $GITHUB_OUTPUT
        echo "arch=$ARCH" >> $GITHUB_OUTPUT
        echo "ðŸ“‹ Detected: $OS/$ARCH"

    - name: Determine kdx version
      id: version
      shell: bash
      run: |
        VERSION="${{ inputs.kdx-version }}"

        if [[ "$VERSION" == "latest" ]]; then
          echo "ðŸ” Fetching latest kdx version..."
          LATEST=$(curl -s https://api.github.com/repos/kodexa-ai/kdx-cli-releases/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
          if [[ -z "$LATEST" ]]; then
            echo "âŒ Failed to fetch latest version"
            exit 1
          fi
          VERSION="$LATEST"
          echo "âœ… Latest version: $VERSION"
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Cache kdx binary
      id: cache
      uses: actions/cache@v4
      with:
        path: ${{ runner.temp }}/kdx-bin
        key: kdx-${{ steps.version.outputs.version }}-${{ steps.detect.outputs.os }}-${{ steps.detect.outputs.arch }}

    - name: Download kdx binary
      if: steps.cache.outputs.cache-hit != 'true'
      shell: bash
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        OS="${{ steps.detect.outputs.os }}"
        ARCH="${{ steps.detect.outputs.arch }}"

        # Construct download URL based on goreleaser naming
        if [[ "$OS" == "windows" ]]; then
          ARCHIVE="kdx_${VERSION#v}_${OS}_${ARCH}.zip"
          BINARY="kdx.exe"
        else
          ARCHIVE="kdx_${VERSION#v}_${OS}_${ARCH}.tar.gz"
          BINARY="kdx"
        fi

        DOWNLOAD_URL="https://github.com/kodexa-ai/kdx-cli-releases/releases/download/${VERSION}/${ARCHIVE}"

        echo "ðŸ“¥ Downloading kdx from: $DOWNLOAD_URL"

        mkdir -p "${{ runner.temp }}/kdx-download"
        cd "${{ runner.temp }}/kdx-download"

        if ! curl -sL -f "$DOWNLOAD_URL" -o "$ARCHIVE"; then
          echo "âŒ Failed to download kdx from $DOWNLOAD_URL"
          echo "Available releases: https://github.com/kodexa-ai/kdx-cli-releases/releases"
          exit 1
        fi

        # Extract archive
        if [[ "$OS" == "windows" ]]; then
          unzip -q "$ARCHIVE"
        else
          tar -xzf "$ARCHIVE"
        fi

        # Move binary to cache location
        mkdir -p "${{ runner.temp }}/kdx-bin"
        mv "$BINARY" "${{ runner.temp }}/kdx-bin/"
        chmod +x "${{ runner.temp }}/kdx-bin/$BINARY"

        echo "âœ… Downloaded kdx $VERSION"

    - name: Add kdx to PATH
      shell: bash
      run: |
        echo "${{ runner.temp }}/kdx-bin" >> $GITHUB_PATH

    - name: Verify kdx installation
      shell: bash
      run: |
        kdx version

    - name: Run kdx sync deploy
      id: sync
      shell: bash
      run: |
        set -e

        # Build command - simple and opinionated
        CMD="kdx sync deploy"

        # Add optional config path
        if [[ -n "${{ inputs.sync-config }}" ]]; then
          CMD="$CMD --config \"${{ inputs.sync-config }}\""
        fi

        # Add optional metadata directory
        if [[ -n "${{ inputs.metadata-dir }}" ]]; then
          CMD="$CMD --metadata-dir \"${{ inputs.metadata-dir }}\""
        fi

        # Add dry-run flag if requested
        if [[ "${{ inputs.dry-run }}" == "true" ]]; then
          CMD="$CMD --dry-run"
        fi

        echo "ðŸš€ Command: $CMD"

        # Run deployment
        OUTPUT=$(eval "$CMD" 2>&1)
        EXIT_CODE=$?

        echo "$OUTPUT"

        if [[ $EXIT_CODE -ne 0 ]]; then
          echo "âŒ Deployment failed with exit code $EXIT_CODE"
          exit $EXIT_CODE
        fi

        # Parse output for statistics (best effort)
        # Match patterns like "Resources: 75 updated" or "project: 2 updated, 3 unchanged"
        # Use sed for portability (works on both GNU and BSD)
        UPDATED=$(echo "$OUTPUT" | sed -n 's/.*Resources:[[:space:]]*\([0-9]*\)[[:space:]]*updated/\1/p' | head -1)
        UPDATED=${UPDATED:-0}
        CREATED=$(echo "$OUTPUT" | sed -n 's/.*resources\?:[[:space:]]*\([0-9]*\)[[:space:]]*created.*/\1/p' | head -1)
        CREATED=${CREATED:-0}
        SKIPPED=$(echo "$OUTPUT" | sed -n 's/.*resources\?:[[:space:]]*\([0-9]*\)[[:space:]]*unchanged.*/\1/p' | head -1)
        SKIPPED=${SKIPPED:-0}
        # Count number of "Planned deployment" lines for targets
        TARGETS=$(echo "$OUTPUT" | grep -c "Planned deployment" || echo "0")

        echo "targets=$TARGETS" >> $GITHUB_OUTPUT
        echo "resources_created=$CREATED" >> $GITHUB_OUTPUT
        echo "resources_updated=$UPDATED" >> $GITHUB_OUTPUT
        echo "resources_skipped=$SKIPPED" >> $GITHUB_OUTPUT

        echo "âœ… Deployment completed successfully"
